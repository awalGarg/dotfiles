#!/usr/bin/env bash

# file: quickclips-action
# author: Awal Garg <quickclips-action@awalgarg.me>
# license: wtfpl

DMENU_ARGS='-i -sb #333 -nb #222 -l 20 -fn Inconsolata'

QUICKCLIPS_CACHE_FILE="${QUICKCLIPS_CACHE_FILE:-"${XDG_CACHE_HOME:-$HOME/.cache}"/quickclipsd-data}"
QUICKCLIPS_ACTIONS_CACHE_FILE="${QUICKCLIPS_ACTIONS_CACHE_FILE:-"${XDG_CACHE_HOME:-$HOME/.cache}"/quickclips-actions}"

entry_selection="$(cat "$QUICKCLIPS_CACHE_FILE" | dmenu -p 'quickclips' $DMENU_ARGS)"

if [ -z "$entry_selection" ]; then
    exit 1
fi

selection_preview="$(printf '%s' "$entry_selection" | head -c 16 | tr -d "'")"
actions_dmenu_command="dmenu -p '$selection_preview' $DMENU_ARGS"
command_selection="$(dmenu-weighted "$QUICKCLIPS_ACTIONS_CACHE_FILE" "$actions_dmenu_command")"

if [ -z "$command_selection" ]; then
    exit 2
fi

function _run {
    _output_store="$(mktemp)"
    sh -c "$1" > "$_output_store" 2>&1 || rofi -no-click-to-exit -e "$(cat $_output_store)" || true
    rm $_output_store
}

case "$command_selection" in
    '| '*)
        cmdtopipeto="$(printf '%s' "$command_selection" | tail -c +2)"
        printf '%s' "$entry_selection" | _run "$cmdtopipeto"
        ;;
    *'<>'*)
        _run "$(printf '%s' "$command_selection" | sed "s|<>|$entry_selection|")"
        ;;
    '#rm')
        _tmp="$(mktemp)"
        grep -v --line-regexp --fixed-strings "$entry_selection" "$QUICKCLIPS_CACHE_FILE" > "$_tmp"
        mv "$_tmp" "$QUICKCLIPS_CACHE_FILE"
        ;;
    *)
        _run "$command_selection \"$entry_selection\""
        ;;
esac
